<!DOCTYPE html>
<html>
<head>
	<title>My AI</title>
	<link rel="stylesheet" href="static/style.css">

	<style>
		#file_upload_form{
		position: relative;
		width: 30%;
		height: 150px;
		border: 3px dashed grey;
		border-radius: 10px;
		z-index:99;
		margin: auto;
		}
		
		#drag_drop_area{
			height: 150px;
			color: #bbb;
			text-align: center;
		}

		
		.form div{
		width: 100%;
		height: 100%;
		text-align: center;
		line-height: 170px;
		color: black;
		font-family: Arial;
		position: absolute;
		top: 10%;
		z-index: -1;
		}
		
		.form input{
		position: relative;
		margin: 0;
		padding: 0;
		width: 100%;
		height: 100%;
		outline: none;
		opacity: 0;
		}
		.form button {
			border-radius: 10px;
			padding: 10px 20px;
			background: #1950A3;
			outline: none;
			border: none;
			color: white;
			font-size: 16px;
		}
		.mx-2 {
			position: relative;
			top: 30px;
			left: -10px;
		}
		#fileName::before {
			content: 'File Name:';
		}
		#fileName {
			position: relative;
			top: 10px;
			color: #eee;
			text-align:center;
		}
		#image-container, #button-container, #result{
			margin-top: 20px;
			text-align: center;
			z-index: 999;
			position: relative;
			color: red;
			font-size: 24px; /* Увеличенный размер шрифта */
		}
		

	</style>
</head>
<body>	
	<!-- {% include 'header.html' %}	 -->
	<form id="file_upload_form" action="/uploadfile/" method="post" enctype="multipart/form-data">
		<div id="drag_drop_area" class="form">
			<img src="static/upload.png" alt="upload" width="15%" class="mx-2">
            Upload your files here or 
			<input name="file" id="entry_value" ref="fileInput" type="file" style="display:none;" onchange="getFileName()">           
			<button type="button" class="btn bg-color-dblue btn-primary px-4 py-3" onclick="document.getElementById('entry_value').click();">Browse</button>
		</div>
	</form>
	<div id="fileName" class="text-primary ">        </div>
	<div id="image-container"></div>
	<div id="button-container"></div>
	<div id="result"> </div>
	
	<script>
		var dragDropArea = document.getElementById("drag_drop_area");
		var fileInput = document.getElementById("entry_value");
	
		dragDropArea.addEventListener("dragover", function(event) {
			event.preventDefault();
		});
	
		dragDropArea.addEventListener("drop", function(event) {
			event.preventDefault();
			var files = event.dataTransfer.files;
			fileInput.files = files;
			getFileName();
		});
		
		function getFileName() {
			var x = document.getElementById('entry_value')
			document.getElementById('fileName').innerHTML = x.value.split('\\').pop()
			const fileInput = document.getElementById("entry_value");
			const file = fileInput.files[0];
			const img_container = document.getElementById("image-container");
			const btn_container = document.getElementById("button-container");
			if (file.type.startsWith("image/")) {
				const reader = new FileReader();
				reader.onload = function(event) {
					const img = new Image();
					img.src = event.target.result;              
					img.width = 300;
					img.height = 200;
					img.setAttribute('id', 'predict-img');
					const button = document.createElement('button');
					button.setAttribute('id', 'predict-button');
					button.textContent = 'ОПРЕДЕЛИТЬ ДИАГНОЗ';
					img_container.innerHTML = '';
					btn_container.innerHTML = '';
					img_container.appendChild(img);
					btn_container.appendChild(button);
					addListener();
				};
				reader.readAsDataURL(file);
			} else {
				img_container.innerHTML = 'Не поддерживаемый формат изображения';
			}          
		}
		
		function addListener() {      
			document.getElementById('predict-button').addEventListener('click', () => {    
				const fileInput = document.getElementById("entry_value");
				const file = fileInput.files[0];
				const formData = new FormData();
				formData.append("image", file);
				
				fetch("http://localhost:8000/predict/", {
					method: "POST",
					body: formData,
				})
				.then((response) => response.json())
				.then((data) => {
					const resultDiv = document.getElementById("result");
					resultDiv.innerHTML = `
						<p>Предсказанный класс: ${data.predicted_class}</p>
						<p>Вероятность: ${data.predicted_probability}</p>
					`;
					
					// Отображение изображения
					const img = new Image();
					img.src = URL.createObjectURL(file);
					img.width = 800;
					img.height = 600;
					resultDiv.appendChild(img);
				})
				.catch((error) => {
					console.error("Error:", error);
				});
			});
		}
	</script>
	</body>
	</html>
